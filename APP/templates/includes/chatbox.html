<!-- Chatbox Section -->
<div id="chat-container">
    <h3>Chat</h3>
    <div id="messages"></div>
    <div id="message-input">
      <input type="text" id="message" placeholder="Type your message here..." onkeydown="handleKeyPress(event)">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
  
  <style>
    #chat-container {
      display: flex; /* Use flexbox for layout */
      flex-direction: column; /* Stack items vertically */
      padding: 10px;
      background-color: #000;
      color: white;
      border-radius: 10px;
    }
  
    #chat-container h3 {
      margin: 0;
      padding-bottom: 10px;
      flex-shrink: 0; /* Prevent the header from shrinking */
    }
  
    #messages {
      flex: 1; /* Allow messages to take up available space */
      overflow-y: auto; /* Add vertical scrolling if content overflows */
      padding: 10px;
      margin-bottom: 10px;
      background-color: #222;
      color: white;
      border-radius: 10px;
    }
  
    #message-input {
      display: flex; /* Use flexbox for input and button */
    }
  
    #message-input input {
      flex: 1; /* Allow the input field to take up available space */
      padding: 10px;
      border-radius: 10px;
      background-color: #333;
      color: white;
      border: none;
    }
  
    #message-input button {
      padding: 10px;
      margin-left: 5px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
  
    #message-input button:hover {
      background-color: #0056b3;
    }
  </style>
  
  <script>
    const messagesDiv = document.getElementById('messages');
    const username = "{{ user.username }}"; // Get the logged-in user's username
  
    // Fetch messages from the server
    async function fetchMessages() {
      try {
        const response = await fetch('/api/get_messages/');
        if (!response.ok) {
          console.error('Failed to fetch messages:', response.statusText);
          return;
        }
        const messages = await response.json();
        messagesDiv.innerHTML = '';
        messages.forEach(msg => {
          const messageElement = document.createElement('div');
          messageElement.innerHTML = `
            <small>${new Date(msg.timestamp).toLocaleString()}</small><br>
            <strong>${msg.user__username}:</strong> ${msg.message}<br>`;
          messageElement.classList.add('message');
          messagesDiv.appendChild(messageElement);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (error) {
        console.error('Error fetching messages:', error);
      }
    }
  
    // Send a new message to the server
    async function sendMessage() {
      const messageInput = document.getElementById('message');
      const messageText = messageInput.value.trim();
  
      if (messageText) {
        try {
          const response = await fetch('/api/save_message/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}' // Ensure CSRF token is included
            },
            body: JSON.stringify({ message: messageText })
          });
  
          if (response.ok) {
            messageInput.value = '';
            fetchMessages();
          } else {
            console.error('Failed to send message:', response.statusText);
          }
        } catch (error) {
          console.error('Error sending message:', error);
        }
      } else {
        console.warn('Message is empty. Please type something before sending.');
      }
    }
  
    // Handle key press in the input field
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent default form submission behavior
        sendMessage(); // Trigger the sendMessage function
      }
    }
  
    // Fetch messages on page load
    fetchMessages();
  </script>